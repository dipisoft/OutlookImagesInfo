'use strict';(function(){let corps=null;let attachments=[];let nbPiecesJointes=-1;let piecesJointes=[];let images=[];let anomalie=false;Office.onReady((info)=>{if(info.host===Office.HostType.Outlook){traiterMessage(Office.context.mailbox.item);}});async function traiterMessage(message){let incertitudeRapprochement=false;try {document.getElementById('imgMaj').classList.add('masque');message.body.getAsync('html',callbackBodyAsync);let t=25;while(corps==null&&t-->0){await attendre();}if(message.attachments){attachments=message.attachments.filter((w)=>w.contentType.startsWith('image/'));nbPiecesJointes=attachments.length;}else{message.getAttachmentsAsync(callbackAttachmentsAsync);t=25;while(nbPiecesJointes===-1&&t-->0){await attendre();}}attachments.forEach((att,index)=>{const options={asyncContext:{'attachment':att,'index':index}};message.getAttachmentContentAsync(att.id,options,callbackAttachmentContentAsync);});t=25;while(piecesJointes.length<nbPiecesJointes&&t-->0){await attendre();}t=1;while(t-->0){await attendre();}const doc=new DOMParser().parseFromString(corps,'text/html');let imgs=Array.from(doc.getElementsByTagName('img'));imgs.forEach((img,index)=>{const mtch=img.src.match(/^((?<lien>https?:\/\/.*)|(?<data>data:image\/.+;base64,.*)|(https:\/\/localhost:[0-9]+\/(?<b64>.*)))$/);let source;let nom;let poids=-1;let type;if(mtch){const lien=mtch.groups['lien'];if(lien!==undefined){source=lien;nom=null;type='Externe';}else{const data=mtch.groups['data'];if(data!==undefined){source=data;}else{const b64=mtch.groups['b64'];const decode=atob(b64);switch(decode.charAt(0)){case '/':format='jpeg';break;case 'i':format='png';break;case 'R':format='gif';break;case 'U':format='webp';break;default:format='undefined';}source=`data:image/${format};base64,${b64}`;}nom=null;type='Intégrée';poids=source.length;}}else{source=img.src;nom=img.tag ?? img.src.split('/').slice(-1).join('');poids=determinerPoids(img);type='Liée';}let resolutionAffichee=determinerResolutionImageAffichee(img);if(!source.startsWith('cid:')){images.push({'id':index,'nom':nom,'alt':img.alt,'resolutionAffichee':resolutionAffichee,'resolutionNative':null,'source':source,'poids':poids,'type':type});determinerResolutionImageNative(source,index).then((reponse)=>{const i=images.findIndex((w)=>w.id===reponse.id);if(reponse.size!=null){images[i]={'nom':nom,'alt':img.alt,'resolutionAffichee':resolutionAffichee,'resolutionNative':reponse.size,'source':source,'poids':poids,'type':type};}else{images[i]={'nom':nom,'alt':img.alt,'resolutionAffichee':resolutionAffichee,'resolutionNative':null,'source':null,'poids':poids,'type':type};}});}else{const cid=nom.substr(4).split('@')[0];const pieceJointe=(piecesJointes.length===1&&imgs.length===1?piecesJointes[0]:piecesJointes.find(w=>w.nom===cid));if(pieceJointe!==undefined){images.push({'nom':cid,'alt':img.alt,'resolutionAffichee':resolutionAffichee,'resolutionNative':pieceJointe.resolutionNative,'source':pieceJointe.source,'poids':pieceJointe.poids,'type':'Jointe'});pieceJointe.affectee=true;}else{images.push({'nom':nom,'alt':img.alt,'resolutionAffichee':resolutionAffichee,'resolutionNative':null,'source':null,'poids':poids,'type':'Introuvable'});}}});t=1;while(t-->0){await attendre();}if(images.some(w=>w.type==='Introuvable')){if(images.filter(w=>w.type==='Introuvable').length===1&&piecesJointes.filter(w=>!w.affectee).length===1){const image=images.find(w=>w.type==='Introuvable');const pieceJointe=piecesJointes.find(w=>!w.affectee);image.nom=pieceJointe.nom;image.resolutionNative=pieceJointe.resolutionNative;image.source=pieceJointe.source;image.poids=pieceJointe.poids;image.type='Jointe';pieceJointe.affectee=true;}else{const piecesJointesTrieesParRatio=piecesJointes.map((x)=>{return {'nom':x.nom,'ratio':x.resolutionNative.width / x.resolutionNative.height,'width':x.resolutionNative.width,'height':x.resolutionNative.height};}).sort((a,b)=>{return(a.ratio<b.ratio?-1:(a.ratio>b.ratio?1:0));});const imagesTrieesParRatio=images.filter(w=>w.type==='Introuvable').map((x)=>{return {'nom':x.nom,'ratio':x.resolutionAffichee.width / x.resolutionAffichee.height,'width':x.resolutionAffichee.width,'height':x.resolutionAffichee.height};}).sort((a,b)=>{return(a.ratio<b.ratio?-1:(a.ratio>b.ratio?1:0));});images.filter(w=>w.type==='Introuvable').forEach((image)=>{const index=imagesTrieesParRatio.findIndex(w=>w.nom===image.nom);if(index>-1&&index<piecesJointes.length){const pieceJointe=piecesJointes.find(w=>w.nom===piecesJointesTrieesParRatio[index].nom);image.nom=pieceJointe.nom;image.resolutionNative=pieceJointe.resolutionNative;image.source=pieceJointe.source;image.poids=pieceJointe.poids;}image.type='Jointe¹';});incertitudeRapprochement=true;}}let tbImages=document.getElementById('tbImages');images.forEach((image)=>{let tr=document.createElement('tr');let imgImage=document.createElement('img');imgImage.src=image.source;if(image.alt!=null&&image.alt.length>0){imgImage.alt=image.alt;imgImage.title=image.alt;}else if(image.nom!=null&&image.nom.length>0){imgImage.alt=image.nom;imgImage.title=image.nom;}imgImage.className='image';let tdImage=document.createElement('td');tdImage.className='centrer';tdImage.appendChild(imgImage);tr.appendChild(tdImage);let tdResolutionAffichee=document.createElement('td');tdResolutionAffichee.className='centrer';tdResolutionAffichee.innerHTML=formaterResolution(image.resolutionAffichee);tr.appendChild(tdResolutionAffichee);const couleur=(image.resolutionNative==null||image.resolutionAffichee==null ||(image.resolutionAffichee.width===0&&image.resolutionAffichee.height===0)?'':(image.resolutionNative.width>image.resolutionAffichee.width?'rouge':'vert'));const comp=(image.resolutionNative==null||image.resolutionAffichee==null||(image.resolutionAffichee.width===0&&image.resolutionAffichee.height===0)?'':(image.resolutionNative.width>image.resolutionAffichee.width?'Surdimensionnée':'Adaptée'));let tdResolutionNative=document.createElement('td');tdResolutionNative.className=`centrer ${couleur}`;tdResolutionNative.innerHTML=`${formaterResolution(image.resolutionNative)}${(comp===''?'':`<br /><small>${comp}</small>`)}`;tr.appendChild(tdResolutionNative);if(couleur==='rouge'){anomalie=true;}let tdPoids=document.createElement('td');tdPoids.className='centrer';tdPoids.innerHTML=formaterPoids(image.poids);tr.appendChild(tdPoids);let tdType=document.createElement('td');tdType.className='centrer';tdType.innerHTML=image.type;tr.appendChild(tdType);tbImages.append(tr);});if(images.length===0){document.getElementById('divAucuneImage').classList.remove('masque');}else{document.getElementById('divListeImages').classList.remove('masque');if(incertitudeRapprochement){document.getElementById('divIncertitudeRapprochement').classList.remove('masque');}let divAnomalie=document.getElementById('divAnomalie');let divBravo=document.getElementById('divBravo');if(anomalie&&divAnomalie){divAnomalie.classList.remove('masque');}else if(divBravo){divBravo.classList.remove('masque');}}} catch(e){let divErreur=document.getElementById('divErreur');divErreur.innerHTML=`<p class="rouge">Erreur rencontrée:${e.message}.<br/><br/>Informations de débogage:${e.stack}</p>`;divErreur.classList.remove('masque');}document.body.classList.remove('attente');document.getElementById('imgMaj').classList.remove('masque');}async function callbackBodyAsync(resultat){if(resultat.status==='succeeded'){corps=resultat.value;}}async function callbackAttachmentsAsync(resultat){if(resultat.status==='succeeded'){attachments=resultat.value;nbPiecesJointes=attachments.length;}else{nbPiecesJointes=0;}}async function callbackAttachmentContentAsync(resultat){const attachment=resultat.asyncContext.attachment;const index=resultat.asyncContext.index;if(resultat.status==='succeeded'){const valeur=resultat.value;if(valeur.format===Office.MailboxEnums.AttachmentContentFormat.Base64){const source=`data:${attachment.contentType};base64,${valeur.content}`;const resolutionNative=await determinerResolutionImageNative(source);piecesJointes[index]={'nom':attachment.name,'resolutionNative':resolutionNative.size,'poids':source.length,'source':source,'affectee':false,'attachment':attachment};}}}})();function determinerResolutionImageAffichee(img){let largeur=0,hauteur=0;if(img.width>0){largeur=img.width;}else if(img.style.width>0){largeur=img.style.width;}else if(img.style.maxWidth>0){largeur=img.style.maxWidth;}if(img.height>0){hauteur=img.height;}else if(img.style.height>0){hauteur=img.style.height;}else if(img.style.maxheight>0){hauteur=img.style.maxheight;}return {'width':largeur,'height':hauteur};}function determinerResolutionImageNative(source,id=null){return new Promise((resolved)=>{let img=new Image();img.onload=function(){resolved({'size':{'width':img.naturalWidth,'height':img.naturalHeight},'id':id})};img.src=source;});}function determinerPoids(img){return -1;}function formaterPoids(poids){if(isNaN(poids)||poids<0){return '<span title="indéterminé">ind.</span>';}else if(poids<1024){return `${poids} o.`;}else if(poids<1024 * 1024){return `${(poids / 1024).toFixed(1)} Ko.`;}else{return `${(poids / 1024 / 1024).toFixed(1)} Mo.`;}}function formaterResolution(resolution){if(resolution==null||(resolution.width===0&&resolution.height===0)){return '<span title="indéterminée">ind.</span>';}else{return `${resolution.width}x${resolution.height}`;}}function attendre(){return new Promise((resolved)=>{setTimeout(()=>{resolved();},100);});}
